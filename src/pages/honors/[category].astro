---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navigation from '../../components/astro/Navigation.astro';
import Footer from '../../components/astro/Footer.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const honors = await getCollection('honors');
  
  // Group honors by category
  const categories = honors.reduce((acc, honor) => {
    const cat = honor.data.category;
    if (!acc[cat]) {
      acc[cat] = [];
    }
    acc[cat].push(honor);
    return acc;
  }, {} as Record<string, any[]>);

  return Object.keys(categories).map(category => ({
    params: { category },
    props: { 
      category,
      honors: (categories[category] || []).sort((a, b) => (b.data.year || 0) - (a.data.year || 0))
    },
  }));
}

const { category, honors } = Astro.props;
const title = honors[0]?.data.title || category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
---

<BaseLayout title={`${title} - Greater Fox Cities Bowling Association`} description={`GFCBA ${title}`}>
  <Navigation />
  
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="font-display font-bold text-4xl mb-8 text-gray-900">{title}</h1>
    
    {honors[0]?.data.description && (
      <p class="text-lg text-gray-700 mb-8">{honors[0].data.description}</p>
    )}

    <div class="space-y-8">
      {honors.map((honor) => (
        <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
          {honor.data.year && (
            <h2 class="font-display font-bold text-2xl mb-4 text-gray-900">
              {honor.data.year}
            </h2>
          )}

          {/* Tabular data display */}
          {honor.data.data && honor.data.data.length > 0 && (
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    {/* @ts-ignore */}
                    {Object.keys(honor.data.data[0]).map((key: string) => (
                      <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        {key}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  {/* @ts-ignore */}
                  {honor.data.data.map((row: any) => (
                    <tr>
                      {Object.values(row).map((value, idx) => (
                        <td class={`px-6 py-4 text-sm ${idx === 0 ? 'font-medium text-gray-900' : 'text-gray-700'}`}>
                          {value as string}
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {/* Recipients display */}
          {/* @ts-ignore */}
          {honor.data.recipients && honor.data.recipients.length > 0 && (
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Name</th>
                    {/* @ts-ignore */}
                    {honor.data.recipients.some((r: any) => r.achievement) && (
                      <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Achievement</th>
                    )}
                    {/* @ts-ignore */}
                    {honor.data.recipients.some((r: any) => r.score) && (
                      <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Score</th>
                    )}
                    {/* @ts-ignore */}
                    {honor.data.recipients.some((r: any) => r.average) && (
                      <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Average</th>
                    )}
                    {/* @ts-ignore */}
                    {honor.data.recipients.some((r: any) => r.games) && (
                      <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Games</th>
                    )}
                    {/* @ts-ignore */}
                    {honor.data.recipients.some((r: any) => r.date) && (
                      <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Date</th>
                    )}
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  {/* @ts-ignore */}
                  {honor.data.recipients.map((recipient: any) => (
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{recipient.name}</td>
                      {/* @ts-ignore */}
                      {honor.data.recipients.some((r: any) => r.achievement) && (
                        <td class="px-6 py-4 text-sm text-gray-700">{recipient.achievement || '—'}</td>
                      )}
                      {/* @ts-ignore */}
                      {honor.data.recipients.some((r: any) => r.score) && (
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{recipient.score || '—'}</td>
                      )}
                      {/* @ts-ignore */}
                      {honor.data.recipients.some((r: any) => r.average) && (
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{recipient.average || '—'}</td>
                      )}
                      {/* @ts-ignore */}
                      {honor.data.recipients.some((r: any) => r.games) && (
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{recipient.games || '—'}</td>
                      )}
                      {/* @ts-ignore */}
                      {honor.data.recipients.some((r: any) => r.date) && (
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{recipient.date || '—'}</td>
                      )}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      ))}
    </div>
  </main>

  <Footer />
</BaseLayout>

---
/**
 * Renders a ComponentSection — either a composite (assembled from primitives)
 * or a standalone primitive placed directly on a page.
 *
 * Composite rendering:
 *   - Loads the composite JSON definition at build time via import.meta.glob
 *   - Resolves {{key}} template strings against section.data
 *   - The first "section" primitive instance (if any) becomes the card wrapper
 *   - All other primitives are rendered as their HTML equivalents
 *
 * Primitive rendering:
 *   - section.data IS the props — rendered as a single primitive element
 *
 * Built-in composites (hero, text-block, card-grid, cta, content-list):
 *   - Rendered with full HTML matching the legacy Astro section components
 */
import type { ComponentSection } from "../../../types/cms";
import { getCollection } from "astro:content";

interface Props {
  section: ComponentSection;
}

const { section } = Astro.props;
const data: Record<string, unknown> = section.data ?? {};

// ── Load all JSON definitions at build time ──────────────────────────────────

const compositeMods = import.meta.glob<{ default: any }>(
  "../../../content/components/composites/*.json",
  { eager: true },
);
const composites: any[] = Object.values(compositeMods).map(
  (m) => m.default ?? m,
);

const primitiveMods = import.meta.glob<{ default: any }>(
  "../../../content/components/primitives/*.json",
  { eager: true },
);
const primitiveMap: Record<string, any> = Object.fromEntries(
  Object.values(primitiveMods).map((m) => {
    const p = m.default ?? m;
    return [p.id, p];
  }),
);

// ── Template variable resolution ─────────────────────────────────────────────

function resolveStr(value: unknown, ctx: Record<string, unknown>): string {
  if (typeof value !== "string")
    return value !== undefined && value !== null ? String(value) : "";
  return value.replace(/\{\{(\w+)\}\}/g, (_: string, key: string) => {
    const v = ctx[key];
    return v !== undefined && v !== null ? String(v) : "";
  });
}

function resolveProps(
  props: Record<string, unknown>,
  ctx: Record<string, unknown>,
): Record<string, unknown> {
  return Object.fromEntries(
    Object.entries(props).map(([k, v]) => [k, resolveStr(v, ctx)]),
  );
}

// ── Spacing maps ─────────────────────────────────────────────────────────────

const paddingMap: Record<string, string> = {
  none: "0",
  small: "0.75rem",
  medium: "1.25rem",
  large: "2rem",
};

const marginClass: Record<string, string> = {
  small: "my-2",
  medium: "my-4",
  large: "my-8",
};

const spacerClass: Record<string, string> = {
  small: "h-4",
  medium: "h-8",
  large: "h-16",
  xlarge: "h-24",
};

// ── Built-in composite IDs —————————————————————————————————————————————————

const BUILT_IN_IDS = ["hero", "text-block", "card-grid", "cta", "content-list"];
const isBuiltIn = BUILT_IN_IDS.includes(section.componentId);

// card-grid: parse pipe-separated card strings into objects
interface CardItem {
  title: string;
  description: string;
  imageUrl: string;
  link: string;
}
let parsedCards: CardItem[] = [];
if (section.componentId === "card-grid" && data.cards) {
  const rawCards = Array.isArray(data.cards) ? data.cards : [data.cards];
  parsedCards = rawCards.map((line: unknown) => {
    const parts = String(line)
      .split("|")
      .map((s) => s.trim());
    return {
      title: parts[0] ?? "",
      description: parts[1] ?? "",
      imageUrl: parts[2] ?? "",
      link: parts[3] ?? "",
    };
  });
}

// content-list: fetch items from the specified collection
let contentListItems: Array<{ id: string; data: Record<string, unknown> }> = [];
if (section.componentId === "content-list" && data.collection) {
  try {
    const collName = String(data.collection);
    const allItems = await getCollection(collName as any);
    const limit = Number(data.limit) || 0;
    contentListItems = (limit > 0 ? allItems.slice(0, limit) : allItems).map(
      (e: any) => ({ id: e.id, data: e.data }),
    );
  } catch {
    // collection doesn't exist or is empty — contentListItems stays []
  }
}

// ── Determine what to render ──────────────────────────────────────────────────

// For a standalone primitive, build a fake single-instance list
let instances: Array<{ primitive: string; props: Record<string, unknown> }> =
  [];
let containerStyle = "";

if (section.componentType === "composite") {
  const composite = composites.find((c) => c.id === section.componentId);
  if (composite) {
    // Extract wrapper props from the "section" primitive instance (if present)
    const sectionInst = composite.components?.find(
      (c: any) => c.primitive === "section",
    );
    if (sectionInst) {
      const cp = resolveProps(sectionInst.props ?? {}, data);
      const parts: string[] = [];
      if (cp.backgroundColor)
        parts.push(`background-color:${cp.backgroundColor}`);
      if (cp.padding)
        parts.push(`padding:${paddingMap[String(cp.padding)] ?? "1.25rem"}`);
      containerStyle = parts.join(";");
    }
    // All non-section primitives become the inner content
    instances = (composite.components ?? [])
      .filter((c: any) => c.primitive !== "section")
      .map((c: any) => ({
        primitive: c.primitive,
        props: resolveProps(c.props ?? {}, data),
      }));
  }
} else {
  // Standalone primitive — data IS the props
  const primDef = primitiveMap[section.componentId];
  if (primDef) {
    instances = [
      {
        primitive: section.componentId,
        props: data as Record<string, unknown>,
      },
    ];
  }
}
---

{
  /* ── Built-in composite renderers ──────────────────────────────────────────── */
}

{
  section.componentId === "hero" && (
    <section class="relative min-h-[500px] overflow-hidden bg-gradient-to-br from-primary to-secondary flex items-center">
      {data.backgroundImage && (
        <div class="absolute inset-0">
          <img
            src={String(data.backgroundImage)}
            alt=""
            class="w-full h-full object-cover"
          />
          <div class="absolute inset-0 bg-black/50" />
        </div>
      )}
      <div class="relative z-10 container mx-auto px-6 text-white text-center py-20">
        {data.title && (
          <h1 class="text-5xl font-bold mb-4">{String(data.title)}</h1>
        )}
        {data.subtitle && (
          <p class="text-xl mb-8 opacity-90">{String(data.subtitle)}</p>
        )}
        {data.ctaText && data.ctaLink && (
          <a
            href={String(data.ctaLink)}
            class="inline-block bg-white text-primary font-bold px-8 py-3 rounded-lg hover:bg-gray-100 transition-colors"
          >
            {String(data.ctaText)}
          </a>
        )}
      </div>
    </section>
  )
}

{
  section.componentId === "text-block" && (
    <section class="py-16 bg-background">
      <div class="container mx-auto px-6 max-w-4xl">
        {data.heading && (
          <h2 class="text-3xl font-bold mb-6 text-foreground">
            {String(data.heading)}
          </h2>
        )}
        {data.content && (
          <div
            class="prose prose-lg max-w-none text-foreground"
            set:html={String(data.content)}
          />
        )}
      </div>
    </section>
  )
}

{
  section.componentId === "card-grid" && (
    <section class="py-16 bg-background">
      <div class="container mx-auto px-6">
        {data.heading && (
          <h2 class="text-3xl font-bold mb-10 text-foreground text-center">
            {String(data.heading)}
          </h2>
        )}
        <div
          class={`grid gap-6 ${
            String(data.columns ?? "3") === "2"
              ? "md:grid-cols-2"
              : String(data.columns ?? "3") === "4"
                ? "md:grid-cols-4"
                : "md:grid-cols-3"
          }`}
        >
          {parsedCards.map((card) => (
            <div class="bg-surface rounded-lg shadow overflow-hidden">
              {card.imageUrl && (
                <img
                  src={card.imageUrl}
                  alt={card.title}
                  class="w-full h-48 object-cover"
                />
              )}
              <div class="p-4">
                {card.title && (
                  <h3 class="font-semibold text-lg mb-2 text-foreground">
                    {card.title}
                  </h3>
                )}
                {card.description && (
                  <p class="text-sm text-muted">{card.description}</p>
                )}
                {card.link && (
                  <a
                    href={card.link}
                    class="mt-3 inline-block text-sm font-medium text-primary hover:underline"
                  >
                    Learn more →
                  </a>
                )}
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  )
}

{
  section.componentId === "cta" && (
    <section class="py-20 bg-gradient-to-br from-primary to-secondary text-white">
      <div class="container mx-auto px-6 text-center">
        {data.heading && (
          <h2 class="text-4xl font-bold mb-8">{String(data.heading)}</h2>
        )}
        {data.buttonText && data.buttonLink && (
          <a
            href={String(data.buttonLink)}
            class={
              String(data.style ?? "primary") === "secondary"
                ? "inline-block bg-transparent border-2 border-white text-white font-bold px-8 py-3 rounded-lg hover:bg-white/10 transition-colors"
                : "inline-block bg-white text-primary font-bold px-8 py-3 rounded-lg hover:bg-gray-100 transition-colors"
            }
          >
            {String(data.buttonText)}
          </a>
        )}
      </div>
    </section>
  )
}

{
  section.componentId === "content-list" && (
    <section class="py-16 bg-background">
      <div class="container mx-auto px-6">
        {data.heading && (
          <h2 class="text-3xl font-bold mb-8 text-foreground">
            {String(data.heading)}
          </h2>
        )}
        {contentListItems.length === 0 ? (
          <p class="text-muted italic">
            No items found in "{String(data.collection)}".
          </p>
        ) : String(data.displayMode ?? "cards") === "table" ? (
          <div class="overflow-x-auto">
            <table class="min-w-full bg-surface border border-border rounded-lg text-sm">
              <thead>
                <tr class="bg-muted/20 text-left">
                  {Object.keys(contentListItems[0]?.data ?? {})
                    .slice(0, 5)
                    .map((key) => (
                      <th class="px-4 py-2 font-semibold capitalize border-b border-border">
                        {key}
                      </th>
                    ))}
                </tr>
              </thead>
              <tbody>
                {contentListItems.map((item) => (
                  <tr class="border-b border-border hover:bg-muted/10">
                    {Object.values(item.data)
                      .slice(0, 5)
                      .map((val) => (
                        <td class="px-4 py-2 text-foreground">
                          {typeof val === "object"
                            ? JSON.stringify(val)
                            : String(val ?? "")}
                        </td>
                      ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : String(data.displayMode ?? "cards") === "list" ? (
          <ul class="space-y-2">
            {contentListItems.map((item) => (
              <li class="flex items-center gap-3 bg-surface rounded p-3 border border-border">
                <span class="font-medium text-foreground">
                  {String(
                    (item.data as any).name ??
                      (item.data as any).title ??
                      item.id,
                  )}
                </span>
              </li>
            ))}
          </ul>
        ) : (
          /* default: cards */
          <div
            class={`grid gap-6 ${
              String(data.columns ?? "3") === "2"
                ? "md:grid-cols-2"
                : String(data.columns ?? "3") === "4"
                  ? "md:grid-cols-4"
                  : "md:grid-cols-3"
            }`}
          >
            {contentListItems.map((item) => {
              const d = item.data as any;
              return (
                <div class="bg-surface rounded-lg shadow p-5 border border-border">
                  <h3 class="font-semibold text-lg mb-1 text-foreground">
                    {String(d.name ?? d.title ?? item.id)}
                  </h3>
                  {d.description && (
                    <p class="text-sm text-muted">{String(d.description)}</p>
                  )}
                  {d.address && (
                    <p class="text-xs text-muted mt-1">{String(d.address)}</p>
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>
    </section>
  )
}

{
  /* ── Generic composite / primitive renderer ─────────────────────────────────── */
}

{
  !isBuiltIn && instances.length > 0 && (
    <div
      class="composite-component rounded shadow-sm overflow-hidden"
      data-component-id={section.componentId}
      data-component-type={section.componentType}
      style={containerStyle || undefined}
    >
      {instances.map(({ primitive, props: p }) => {
        /* ── text ── */
        if (primitive === "text") {
          return (
            <div class={`text-${String(p.alignment ?? "left")}`}>
              {p.heading && (
                <h3 class="font-bold text-lg mb-1">{String(p.heading)}</h3>
              )}
              {p.content && <p class="text-sm">{String(p.content)}</p>}
            </div>
          );
        }

        /* ── image ── */
        if (primitive === "image" && p.src) {
          return (
            <figure class="m-0">
              <img
                src={String(p.src)}
                alt={p.alt ? String(p.alt) : ""}
                style={`width:${String(p.width ?? "100%")};height:${String(p.height ?? "auto")}`}
                class="max-w-full block"
              />
              {p.caption && (
                <figcaption class="text-xs text-gray-500 mt-1 px-1">
                  {String(p.caption)}
                </figcaption>
              )}
            </figure>
          );
        }

        /* ── button ── */
        if (primitive === "button" && p.link) {
          const styleValue = String(p.style ?? "primary");
          const btnClass =
            styleValue === "primary"
              ? "bg-primary text-white hover:opacity-90"
              : styleValue === "secondary"
                ? "bg-secondary text-primary hover:opacity-90"
                : styleValue === "outline"
                  ? "border border-primary text-primary hover:bg-primary hover:text-white"
                  : "text-primary underline";
          return (
            <a
              href={String(p.link)}
              class={`inline-block px-4 py-2 rounded font-semibold transition-colors text-sm ${btnClass}`}
            >
              {String(p.text ?? "")}
            </a>
          );
        }

        /* ── link ── */
        if (primitive === "link" && p.href) {
          return (
            <a
              href={String(p.href)}
              target={p.openInNewTab ? "_blank" : undefined}
              rel={p.openInNewTab ? "noopener noreferrer" : undefined}
              class={`text-primary text-sm ${p.underline !== "false" && p.underline !== false ? "underline" : ""}`}
            >
              {String(p.text ?? p.href)}
            </a>
          );
        }

        /* ── list ── */
        if (primitive === "list") {
          const rawItems = p.items;
          const items: string[] = Array.isArray(rawItems)
            ? rawItems.map(String)
            : typeof rawItems === "string" && rawItems
              ? rawItems.split(",").map((s) => s.trim())
              : [];
          return (
            <div>
              {p.heading && (
                <h4 class="font-semibold text-sm mb-1">{String(p.heading)}</h4>
              )}
              {p.ordered === "true" || p.ordered === true ? (
                <ol class="list-decimal list-inside text-sm space-y-0.5">
                  {items.map((item) => (
                    <li>{item}</li>
                  ))}
                </ol>
              ) : (
                <ul class="list-disc list-inside text-sm space-y-0.5">
                  {items.map((item) => (
                    <li>{item}</li>
                  ))}
                </ul>
              )}
            </div>
          );
        }

        /* ── divider ── */
        if (primitive === "divider") {
          const thickness = String(p.thickness ?? "thin");
          const thicknessClass =
            thickness === "thick"
              ? "border-2"
              : thickness === "medium"
                ? "border"
                : "border-t";
          const mc = marginClass[String(p.margin ?? "medium")] ?? "my-4";
          return (
            <hr
              class={`${thicknessClass} ${mc} border-gray-200`}
              style={p.color ? `border-color:${String(p.color)}` : undefined}
            />
          );
        }

        /* ── spacer ── */
        if (primitive === "spacer") {
          const sc = spacerClass[String(p.size ?? "medium")] ?? "h-8";
          return <div class={sc} aria-hidden="true" />;
        }

        /* ── table ── */
        if (primitive === "table") {
          return (
            <div class="overflow-x-auto text-sm">
              <table class="min-w-full border-collapse">
                {p.heading && (
                  <caption class="font-semibold text-left mb-1">
                    {String(p.heading)}
                  </caption>
                )}
              </table>
            </div>
          );
        }

        /* ── unknown primitive — skip silently ── */
        return null;
      })}
    </div>
  )
}

{
  !isBuiltIn && instances.length === 0 && (
    <div class="p-4 border border-dashed border-orange-300 bg-orange-50 text-orange-700 text-sm rounded">
      Component not found: <code class="font-mono">{section.componentId}</code>
    </div>
  )
}

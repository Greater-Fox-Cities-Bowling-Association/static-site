---
/**
 * Renders a ComponentSection — either a composite (assembled from primitives
 * and/or other composites) or a standalone primitive placed directly on a page.
 *
 * ALL components (except primitives) are built from primitives or other composites
 * via their JSON definitions — there are no special-cased IDs.
 *
 * Composite rendering:
 *   - Loads the composite JSON definition at build time via import.meta.glob
 *   - Resolves {{key}} template strings against section.data
 *   - The first "section" primitive instance (if any) becomes the container wrapper
 *   - All other instances (primitives or nested composites) are rendered in order
 *
 * Primitive rendering:
 *   - section.data IS the props — rendered as a single primitive element
 *
 * Supported primitives: text, image, button, link, list, divider, spacer,
 *   table, cards (pipe-separated card grid), collection (async CMS data)
 */
import type { ComponentSection } from "../../../types/cms";
import { getCollection } from "astro:content";
import NestedComposite from "./CompositeSection.astro";

interface Props {
  section: ComponentSection;
}

const { section } = Astro.props;
const data: Record<string, unknown> = section.data ?? {};

// ── Load all JSON definitions at build time ──────────────────────────────────

const compositeMods = import.meta.glob<{ default: any }>(
  "../../../content/components/composites/*.json",
  { eager: true },
);
const composites: any[] = Object.values(compositeMods).map(
  (m) => m.default ?? m,
);

const primitiveMods = import.meta.glob<{ default: any }>(
  "../../../content/components/primitives/*.json",
  { eager: true },
);
const primitiveMap: Record<string, any> = Object.fromEntries(
  Object.values(primitiveMods).map((m) => {
    const p = m.default ?? m;
    return [p.id, p];
  }),
);

// ── Template variable resolution ─────────────────────────────────────────────

function resolveStr(value: unknown, ctx: Record<string, unknown>): string {
  if (typeof value !== "string")
    return value !== undefined && value !== null ? String(value) : "";
  return value.replace(/\{\{(\w+)\}\}/g, (_: string, key: string) => {
    const v = ctx[key];
    return v !== undefined && v !== null ? String(v) : "";
  });
}

function resolveProps(
  props: Record<string, unknown>,
  ctx: Record<string, unknown>,
): Record<string, unknown> {
  return Object.fromEntries(
    Object.entries(props).map(([k, v]) => [k, resolveStr(v, ctx)]),
  );
}

// ── Spacing maps ─────────────────────────────────────────────────────────────

const paddingMap: Record<string, string> = {
  none: "0",
  small: "0.75rem",
  medium: "1.25rem",
  large: "2rem",
};

const marginClass: Record<string, string> = {
  small: "my-2",
  medium: "my-4",
  large: "my-8",
};

const spacerClass: Record<string, string> = {
  small: "h-4",
  medium: "h-8",
  large: "h-16",
  xlarge: "h-24",
};

// ── Determine what to render ──────────────────────────────────────────────────

// Instances can be primitive renders OR nested composite renders
type InstanceItem =
  | { kind: "primitive"; primitive: string; props: Record<string, unknown> }
  | { kind: "composite"; compositeId: string; props: Record<string, unknown> };

let instances: InstanceItem[] = [];
let containerStyle = "";

if (section.componentType === "composite") {
  const composite = composites.find((c) => c.id === section.componentId);
  if (composite) {
    // Extract wrapper props from the "section" primitive instance (if present)
    const sectionInst = composite.components?.find(
      (c: any) => c.primitive === "section" && c.kind !== "composite",
    );
    if (sectionInst) {
      const cp = resolveProps(sectionInst.props ?? {}, data);
      const parts: string[] = [];
      if (cp.backgroundColor)
        parts.push(`background-color:${cp.backgroundColor}`);
      if (cp.padding)
        parts.push(`padding:${paddingMap[String(cp.padding)] ?? "1.25rem"}`);
      containerStyle = parts.join(";");
    }
    // Build instance list — composites embedded inline, primitives as before
    instances = (composite.components ?? [])
      .filter((c: any) => c.kind === "composite" || c.primitive !== "section")
      .map((c: any): InstanceItem => {
        if (c.kind === "composite") {
          return {
            kind: "composite",
            compositeId: c.composite as string,
            props: resolveProps(c.props ?? {}, data),
          };
        }
        return {
          kind: "primitive",
          primitive: c.primitive as string,
          props: resolveProps(c.props ?? {}, data),
        };
      });
  }
} else {
  // Standalone primitive — data IS the props
  const primDef = primitiveMap[section.componentId];
  if (primDef) {
    instances = [
      {
        kind: "primitive",
        primitive: section.componentId,
        props: data as Record<string, unknown>,
      },
    ];
  }
}

// ── Pre-fetch data for any "collection" primitive instances ──────────────────

const collectionDataMap = new Map<string, any[]>();
for (const inst of instances) {
  if (inst.kind === "primitive" && (inst as any).primitive === "collection") {
    const source = String(inst.props.source ?? "");
    if (source && !collectionDataMap.has(source)) {
      try {
        const allItems = await getCollection(source as any);
        const limit = Number(inst.props.limit) || 0;
        collectionDataMap.set(
          source,
          limit > 0 ? allItems.slice(0, limit) : allItems,
        );
      } catch {
        collectionDataMap.set(source, []);
      }
    }
  }
}
---

{
  /* ── Composite / primitive renderer ──────────────────────────────────────── */
}

{
  instances.length > 0 && (
    <div
      class="composite-component rounded shadow-sm overflow-hidden"
      data-component-id={section.componentId}
      data-component-type={section.componentType}
      style={containerStyle || undefined}
    >
      {instances.map((inst) => {
        /* ── nested composite ── */
        if (inst.kind === "composite") {
          const nestedSection = {
            id: `nested-${inst.compositeId}-${Math.random().toString(36).slice(2)}`,
            type: "component" as const,
            componentType: "composite" as const,
            componentId: inst.compositeId,
            columns: 12,
            data: inst.props,
          };
          return <NestedComposite section={nestedSection as any} />;
        }

        const primitive = (inst as any).primitive ?? "";
        const p = inst.props;

        /* ── text ── */
        if (primitive === "text") {
          return (
            <div class={`text-${String(p.alignment ?? "left")}`}>
              {p.heading && (
                <h3 class="font-bold text-lg mb-1">{String(p.heading)}</h3>
              )}
              {p.content && <p class="text-sm">{String(p.content)}</p>}
            </div>
          );
        }

        /* ── image ── */
        if (primitive === "image" && p.src) {
          return (
            <figure class="m-0">
              <img
                src={String(p.src)}
                alt={p.alt ? String(p.alt) : ""}
                style={`width:${String(p.width ?? "100%")};height:${String(p.height ?? "auto")}`}
                class="max-w-full block"
              />
              {p.caption && (
                <figcaption class="text-xs text-gray-500 mt-1 px-1">
                  {String(p.caption)}
                </figcaption>
              )}
            </figure>
          );
        }

        /* ── button ── */
        if (primitive === "button" && p.link) {
          const styleValue = String(p.style ?? "primary");
          const btnClass =
            styleValue === "primary"
              ? "bg-primary text-white hover:opacity-90"
              : styleValue === "secondary"
                ? "bg-secondary text-primary hover:opacity-90"
                : styleValue === "outline"
                  ? "border border-primary text-primary hover:bg-primary hover:text-white"
                  : "text-primary underline";
          return (
            <a
              href={String(p.link)}
              class={`inline-block px-4 py-2 rounded font-semibold transition-colors text-sm ${btnClass}`}
            >
              {String(p.text ?? "")}
            </a>
          );
        }

        /* ── link ── */
        if (primitive === "link" && p.href) {
          return (
            <a
              href={String(p.href)}
              target={p.openInNewTab ? "_blank" : undefined}
              rel={p.openInNewTab ? "noopener noreferrer" : undefined}
              class={`text-primary text-sm ${p.underline !== "false" && p.underline !== false ? "underline" : ""}`}
            >
              {String(p.text ?? p.href)}
            </a>
          );
        }

        /* ── list ── */
        if (primitive === "list") {
          const rawItems = p.items;
          const items: string[] = Array.isArray(rawItems)
            ? rawItems.map(String)
            : typeof rawItems === "string" && rawItems
              ? rawItems.split(",").map((s) => s.trim())
              : [];
          return (
            <div>
              {p.heading && (
                <h4 class="font-semibold text-sm mb-1">{String(p.heading)}</h4>
              )}
              {p.ordered === "true" || p.ordered === true ? (
                <ol class="list-decimal list-inside text-sm space-y-0.5">
                  {items.map((item) => (
                    <li>{item}</li>
                  ))}
                </ol>
              ) : (
                <ul class="list-disc list-inside text-sm space-y-0.5">
                  {items.map((item) => (
                    <li>{item}</li>
                  ))}
                </ul>
              )}
            </div>
          );
        }

        /* ── divider ── */
        if (primitive === "divider") {
          const thickness = String(p.thickness ?? "thin");
          const thicknessClass =
            thickness === "thick"
              ? "border-2"
              : thickness === "medium"
                ? "border"
                : "border-t";
          const mc = marginClass[String(p.margin ?? "medium")] ?? "my-4";
          return (
            <hr
              class={`${thicknessClass} ${mc} border-gray-200`}
              style={p.color ? `border-color:${String(p.color)}` : undefined}
            />
          );
        }

        /* ── spacer ── */
        if (primitive === "spacer") {
          const sc = spacerClass[String(p.size ?? "medium")] ?? "h-8";
          return <div class={sc} aria-hidden="true" />;
        }

        /* ── cards (grid of pipe-separated items) ── */
        if (primitive === "cards") {
          const rawItems = p.items;
          const cardItems: string[] = Array.isArray(rawItems)
            ? rawItems.map(String)
            : typeof rawItems === "string" && rawItems
              ? rawItems.split("\n").filter(Boolean)
              : [];
          const colCount = String(p.columns ?? "3");
          const gridClass =
            colCount === "2"
              ? "md:grid-cols-2"
              : colCount === "4"
                ? "md:grid-cols-4"
                : "md:grid-cols-3";
          return (
            <div class={`grid gap-4 grid-cols-1 ${gridClass}`}>
              {cardItems.map((item) => {
                const parts = item.split("|").map((s) => s.trim());
                const cardTitle = parts[0] ?? "";
                const cardDesc = parts[1] ?? "";
                const cardImg = parts[2] ?? "";
                const cardLink = parts[3] ?? "";
                return (
                  <div class="bg-surface rounded-lg shadow overflow-hidden border border-border">
                    {cardImg && (
                      <img
                        src={cardImg}
                        alt={cardTitle}
                        class="w-full h-48 object-cover"
                      />
                    )}
                    <div class="p-4">
                      {cardTitle && (
                        <h3 class="font-semibold text-lg mb-2 text-foreground">
                          {cardTitle}
                        </h3>
                      )}
                      {cardDesc && <p class="text-sm text-muted">{cardDesc}</p>}
                      {cardLink && (
                        <a
                          href={cardLink}
                          class="mt-3 inline-block text-sm font-medium text-primary hover:underline"
                        >
                          Learn more →
                        </a>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          );
        }

        /* ── collection (dynamic CMS data) ── */
        if (primitive === "collection") {
          const source = String(p.source ?? "");
          const collItems = collectionDataMap.get(source) ?? [];
          const mode = String(p.displayMode ?? "cards");
          const colCount = String(p.columns ?? "3");
          const gridClass =
            colCount === "2"
              ? "md:grid-cols-2"
              : colCount === "4"
                ? "md:grid-cols-4"
                : "md:grid-cols-3";
          if (collItems.length === 0) {
            return (
              <p class="text-muted italic">No items found in "{source}".</p>
            );
          }
          if (mode === "table") {
            return (
              <div class="overflow-x-auto">
                <table class="min-w-full bg-surface border border-border rounded-lg text-sm">
                  <thead>
                    <tr class="bg-muted/20 text-left">
                      {Object.keys(collItems[0]?.data ?? {})
                        .slice(0, 5)
                        .map((key: string) => (
                          <th class="px-4 py-2 font-semibold capitalize border-b border-border">
                            {key}
                          </th>
                        ))}
                    </tr>
                  </thead>
                  <tbody>
                    {collItems.map((item: any) => (
                      <tr class="border-b border-border hover:bg-muted/10">
                        {Object.values(item.data ?? {})
                          .slice(0, 5)
                          .map((val: unknown) => (
                            <td class="px-4 py-2 text-foreground">
                              {typeof val === "object"
                                ? JSON.stringify(val)
                                : String(val ?? "")}
                            </td>
                          ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            );
          }
          if (mode === "list") {
            return (
              <ul class="space-y-2">
                {collItems.map((item: any) => (
                  <li class="flex items-center gap-3 bg-surface rounded p-3 border border-border">
                    <span class="font-medium text-foreground">
                      {String(item.data?.name ?? item.data?.title ?? item.id)}
                    </span>
                  </li>
                ))}
              </ul>
            );
          }
          // default: cards
          return (
            <div class={`grid gap-6 grid-cols-1 ${gridClass}`}>
              {collItems.map((item: any) => {
                const d = item.data ?? {};
                return (
                  <div class="bg-surface rounded-lg shadow p-5 border border-border">
                    <h3 class="font-semibold text-lg mb-1 text-foreground">
                      {String(d.name ?? d.title ?? item.id)}
                    </h3>
                    {d.description && (
                      <p class="text-sm text-muted">{String(d.description)}</p>
                    )}
                    {d.address && (
                      <p class="text-xs text-muted mt-1">{String(d.address)}</p>
                    )}
                  </div>
                );
              })}
            </div>
          );
        }

        /* ── table ── */
        if (primitive === "table") {
          return (
            <div class="overflow-x-auto text-sm">
              <table class="min-w-full border-collapse">
                {p.heading && (
                  <caption class="font-semibold text-left mb-1">
                    {String(p.heading)}
                  </caption>
                )}
              </table>
            </div>
          );
        }

        /* ── unknown primitive — skip silently ── */
        return null;
      })}
    </div>
  )
}

{
  instances.length === 0 && (
    <div class="p-4 border border-dashed border-orange-300 bg-orange-50 text-orange-700 text-sm rounded">
      Component not found: <code class="font-mono">{section.componentId}</code>
    </div>
  )
}
